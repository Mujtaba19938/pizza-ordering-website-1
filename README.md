# Pizza Ordering Website - Stripe Integration

## Phase 1: Stripe Payments Setup

### Environment Variables

Create a `.env.local` file in your project root with the following variables:

\`\`\`env
# Stripe Keys (get from Stripe Dashboard → Developers → API keys)
STRIPE_SECRET_KEY=sk_test_your_stripe_secret_key_here
STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key_here

# Webhook Secret (generated by Stripe CLI - see setup below)
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here

# App Base URL
APP_BASE_URL=http://localhost:3000
\`\`\`

**Important**: The app will log clear errors if any required environment variables are missing, preventing crashes.

### Getting Your Stripe Keys

1. **Sign up/Login to Stripe**: https://dashboard.stripe.com
2. **Get API Keys**: 
   - Go to Developers → API keys
   - Copy your **Publishable key** (starts with `pk_test_`) 
   - Copy your **Secret key** (starts with `sk_test_`)
   - Add both to your `.env.local` file

### Stripe CLI Setup for Local Development

1. **Install Stripe CLI**: https://stripe.com/docs/stripe-cli
2. **Login to your Stripe account**:
   \`\`\`bash
   stripe login
   \`\`\`
3. **Forward webhook events to your local server**:
   \`\`\`bash
   stripe listen --forward-to localhost:3000/api/stripe/webhook
   \`\`\`
4. **Copy the webhook signing secret** from the CLI output (starts with `whsec_`) and add it to your `.env.local` file as `STRIPE_WEBHOOK_SECRET`

### Test Card Numbers

Use these test card numbers in Stripe Checkout:

- **Visa**: 4242 4242 4242 4242
- **Visa (debit)**: 4000 0566 5566 5556
- **Mastercard**: 5555 5555 5555 4444
- **American Express**: 3782 822463 10005
- **Declined card**: 4000 0000 0000 0002

**Expiry**: Use any future date (e.g., 12/34)  
**CVC**: Use any 3-digit number (e.g., 123)

### How It Works

1. **Checkout Process**: 
   - User fills out billing information and clicks "Pay Now"
   - Frontend calls `/api/checkout/create-session` with cart items and customer data
   - Server creates a Stripe Checkout Session and returns the URL
   - User is redirected to Stripe's hosted checkout page

2. **Payment Completion**:
   - After successful payment, Stripe redirects to `/order/success`
   - Stripe sends webhook to `/api/stripe/webhook` to mark order as paid
   - Order status is updated from "pending_payment" to "paid"

3. **Order Tracking**:
   - Orders are stored in memory (replace with database in production)
   - Each order gets a unique tracking code for customer reference

### Environment Variable Usage

- `STRIPE_SECRET_KEY`: Used server-side for creating checkout sessions and processing webhooks
- `STRIPE_PUBLISHABLE_KEY`: Reserved for future client-side Stripe Elements (not currently used)
- `STRIPE_WEBHOOK_SECRET`: Used to verify webhook signatures from Stripe
- `APP_BASE_URL`: Used for success/cancel URLs in checkout sessions

### Acceptance Tests for Phase 1

- ✅ "Pay Now" opens Stripe Checkout with correct items & amounts
- ✅ Completing test payment marks order paid in DB (via webhook)
- ✅ Success page renders without errors
- ✅ No keys hardcoded; only env vars used
- ✅ App handles missing environment variables gracefully with clear error messages

### Next Steps

After Phase 1 tests pass, proceed to Phase 2 (Order Tracking Backbone) as outlined in the configuration document.

### Production Deployment

When ready for production:
1. Replace test keys with live keys from Stripe Dashboard
2. Update `APP_BASE_URL` to your production domain
3. Create a production webhook in Stripe Dashboard pointing to your live webhook endpoint
4. Update `STRIPE_WEBHOOK_SECRET` with the production webhook secret
